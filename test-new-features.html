<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæ¨¡å¼ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }
        .warning {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #FFC107;
        }
        button {
            background: #00d4ff;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00b8e6;
        }
        .json-output {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ® æ¸¸æˆæ¨¡å¼ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ ç³»ç»ŸåŠ è½½æµ‹è¯•</h2>
            <div id="loadingTests"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ¯ å…³å¡é…ç½®æµ‹è¯•</h2>
            <button onclick="testLevelConfig()">æµ‹è¯•å…³å¡é…ç½®</button>
            <div id="levelConfigTests"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š è¿›åº¦ç³»ç»Ÿæµ‹è¯•</h2>
            <button onclick="testProgressionSystem()">æµ‹è¯•è¿›åº¦ç³»ç»Ÿ</button>
            <button onclick="resetProgress()">é‡ç½®è¿›åº¦</button>
            <div id="progressionTests"></div>
        </div>
        
        <div class="test-section">
            <h2>â™¾ï¸ æ— é™æ¨¡å¼æµ‹è¯•</h2>
            <button onclick="testEndlessMode()">æµ‹è¯•æ— é™æ¨¡å¼</button>
            <div id="endlessTests"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ® æ¸¸æˆæ¨¡å¼ç®¡ç†å™¨æµ‹è¯•</h2>
            <button onclick="testGameModeManager()">æµ‹è¯•æ¨¡å¼ç®¡ç†å™¨</button>
            <div id="gameModeTests"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ–¼ï¸ UIç»„ä»¶æµ‹è¯•</h2>
            <button onclick="testUIComponents()">æµ‹è¯•UIç»„ä»¶</button>
            <div id="uiTests"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”— é›†æˆæµ‹è¯•</h2>
            <button onclick="runIntegrationTests()">è¿è¡Œé›†æˆæµ‹è¯•</button>
            <div id="integrationTests"></div>
        </div>
    </div>

    <!-- å¼•å…¥æ‰€æœ‰æ¸¸æˆè„šæœ¬ -->
    <script src="src/config/LevelConfig.js"></script>
    <script src="src/systems/GameModeManager.js"></script>
    <script src="src/systems/ProgressionSystem.js"></script>
    <script src="src/modes/EndlessMode.js"></script>
    <script src="src/ui/GameModeSelector.js"></script>

    <script>
        // æµ‹è¯•ç»“æœæ˜¾ç¤ºå‡½æ•°
        function showTestResult(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function showJSONResult(containerId, data, title = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'test-result success';
            if (title) {
                const titleEl = document.createElement('div');
                titleEl.textContent = title;
                titleEl.style.fontWeight = 'bold';
                titleEl.style.marginBottom = '10px';
                div.appendChild(titleEl);
            }
            const pre = document.createElement('pre');
            pre.className = 'json-output';
            pre.textContent = JSON.stringify(data, null, 2);
            div.appendChild(pre);
            container.appendChild(div);
        }

        // ç³»ç»ŸåŠ è½½æµ‹è¯•
        function testSystemLoading() {
            const tests = [
                { name: 'LevelConfig', class: typeof LevelConfig !== 'undefined' },
                { name: 'GameModeManager', class: typeof GameModeManager !== 'undefined' },
                { name: 'ProgressionSystem', class: typeof ProgressionSystem !== 'undefined' },
                { name: 'EndlessMode', class: typeof EndlessMode !== 'undefined' },
                { name: 'GameModeSelector', class: typeof GameModeSelector !== 'undefined' }
            ];

            const container = document.getElementById('loadingTests');
            container.innerHTML = '';

            tests.forEach(test => {
                const type = test.class ? 'success' : 'error';
                const message = `${test.name}: ${test.class ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`;
                showTestResult('loadingTests', message, type);
            });
        }

        // å…³å¡é…ç½®æµ‹è¯•
        function testLevelConfig() {
            const container = document.getElementById('levelConfigTests');
            container.innerHTML = '';

            try {
                // æµ‹è¯•è·å–æ‰€æœ‰å…³å¡
                const allLevels = LevelConfig.getAllLevels();
                showTestResult('levelConfigTests', `âœ… è·å–æ‰€æœ‰å…³å¡æˆåŠŸï¼Œå…± ${allLevels.length} ä¸ªå…³å¡`, 'success');
                showJSONResult('levelConfigTests', allLevels.slice(0, 3), 'å‰3ä¸ªå…³å¡æ•°æ®:');

                // æµ‹è¯•è·å–ç‰¹å®šå…³å¡
                const level1 = LevelConfig.getLevel(1);
                if (level1) {
                    showTestResult('levelConfigTests', 'âœ… è·å–å…³å¡1æˆåŠŸ', 'success');
                    showJSONResult('levelConfigTests', level1, 'å…³å¡1è¯¦ç»†ä¿¡æ¯:');
                } else {
                    showTestResult('levelConfigTests', 'âŒ è·å–å…³å¡1å¤±è´¥', 'error');
                }

                // æµ‹è¯•å…³å¡è§£é”é€»è¾‘
                const isLevel1Unlocked = LevelConfig.isLevelUnlocked(1, []);
                const isLevel2Unlocked = LevelConfig.isLevelUnlocked(2, []);
                const isLevel2UnlockedAfterLevel1 = LevelConfig.isLevelUnlocked(2, [1]);

                showTestResult('levelConfigTests', `âœ… å…³å¡1è§£é”çŠ¶æ€: ${isLevel1Unlocked}`, 'success');
                showTestResult('levelConfigTests', `âœ… å…³å¡2è§£é”çŠ¶æ€(æ— å‰ç½®): ${isLevel2Unlocked}`, 'warning');
                showTestResult('levelConfigTests', `âœ… å…³å¡2è§£é”çŠ¶æ€(å®Œæˆå…³å¡1): ${isLevel2UnlockedAfterLevel1}`, 'success');

            } catch (error) {
                showTestResult('levelConfigTests', `âŒ å…³å¡é…ç½®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿›åº¦ç³»ç»Ÿæµ‹è¯•
        function testProgressionSystem() {
            const container = document.getElementById('progressionTests');
            container.innerHTML = '';

            try {
                // åˆ›å»ºæ¨¡æ‹Ÿæ¸¸æˆå®ä¾‹
                const mockGame = {
                    eventSystem: {
                        on: function(event, callback) {
                            console.log(`EventSystem: ç›‘å¬äº‹ä»¶ ${event}`);
                        },
                        emit: function(event, data) {
                            console.log(`EventSystem: è§¦å‘äº‹ä»¶ ${event}`, data);
                        }
                    }
                };

                const progressionSystem = new ProgressionSystem(mockGame);
                showTestResult('progressionTests', 'âœ… è¿›åº¦ç³»ç»Ÿå®ä¾‹åŒ–æˆåŠŸ', 'success');

                // æµ‹è¯•ç©å®¶æ•°æ®
                const playerData = progressionSystem.getPlayerData();
                showJSONResult('progressionTests', {
                    playerLevel: playerData.playerLevel,
                    totalExperience: playerData.totalExperience,
                    completedLevels: playerData.completedLevels,
                    achievements: playerData.achievements
                }, 'ç©å®¶æ•°æ®æ‘˜è¦:');

                // æµ‹è¯•å…³å¡è§£é”
                const level1Unlocked = progressionSystem.isLevelUnlocked(1);
                const level2Unlocked = progressionSystem.isLevelUnlocked(2);
                showTestResult('progressionTests', `âœ… å…³å¡1è§£é”: ${level1Unlocked}`, 'success');
                showTestResult('progressionTests', `âœ… å…³å¡2è§£é”: ${level2Unlocked}`, level2Unlocked ? 'success' : 'warning');

                // æµ‹è¯•æˆå°±ç³»ç»Ÿ
                const achievements = progressionSystem.getAchievements();
                showTestResult('progressionTests', `âœ… è·å–æˆå°±åˆ—è¡¨æˆåŠŸï¼Œå…± ${achievements.length} ä¸ªæˆå°±`, 'success');
                
                const unlockedAchievements = achievements.filter(a => a.unlocked);
                showTestResult('progressionTests', `âœ… å·²è§£é”æˆå°±: ${unlockedAchievements.length} / ${achievements.length}`, 'success');

            } catch (error) {
                showTestResult('progressionTests', `âŒ è¿›åº¦ç³»ç»Ÿæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ— é™æ¨¡å¼æµ‹è¯•
        function testEndlessMode() {
            const container = document.getElementById('endlessTests');
            container.innerHTML = '';

            try {
                // åˆ›å»ºæ¨¡æ‹Ÿæ¸¸æˆå®ä¾‹
                const mockGame = {
                    canvas: { width: 800, height: 600 },
                    eventSystem: {
                        on: function(event, callback) {
                            console.log(`EventSystem: ç›‘å¬äº‹ä»¶ ${event}`);
                        },
                        emit: function(event, data) {
                            console.log(`EventSystem: è§¦å‘äº‹ä»¶ ${event}`, data);
                        }
                    },
                    enemySystem: {
                        enemies: [],
                        addEnemy: function(enemy) {
                            this.enemies.push(enemy);
                            console.log('æ·»åŠ æ•Œäºº:', enemy.type);
                        }
                    },
                    particleSystem: {
                        createBossSpawnEffect: function(x, y) {
                            console.log(`Bossç”Ÿæˆç‰¹æ•ˆ: (${x}, ${y})`);
                        },
                        createLightningEffect: function(x, y) {
                            console.log(`é›·ç”µç‰¹æ•ˆ: (${x}, ${y})`);
                        },
                        createHealingEffect: function(x, y) {
                            console.log(`æ²»ç–—ç‰¹æ•ˆ: (${x}, ${y})`);
                        }
                    }
                };

                const endlessMode = new EndlessMode(mockGame);
                showTestResult('endlessTests', 'âœ… æ— é™æ¨¡å¼å®ä¾‹åŒ–æˆåŠŸ', 'success');

                // æµ‹è¯•çŠ¶æ€
                const initialStatus = endlessMode.getStatus();
                showJSONResult('endlessTests', initialStatus, 'åˆå§‹çŠ¶æ€:');

                // æ¨¡æ‹Ÿå¼€å§‹æ¸¸æˆ
                endlessMode.start('normal');
                showTestResult('endlessTests', 'âœ… æ— é™æ¨¡å¼å¼€å§‹æˆåŠŸ', 'success');

                const runningStatus = endlessMode.getStatus();
                showJSONResult('endlessTests', runningStatus, 'è¿è¡Œä¸­çŠ¶æ€:');

                // æµ‹è¯•æ•Œäººç”Ÿæˆ
                endlessMode.spawnEnemy();
                endlessMode.spawnEnemy(true); // ç‰¹æ®Šæ•Œäºº
                showTestResult('endlessTests', `âœ… æ•Œäººç”Ÿæˆæµ‹è¯•å®Œæˆï¼Œå½“å‰æ•Œäººæ•°: ${mockGame.enemySystem.enemies.length}`, 'success');

                // åœæ­¢æµ‹è¯•
                endlessMode.end();
                showTestResult('endlessTests', 'âœ… æ— é™æ¨¡å¼ç»“æŸæµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                showTestResult('endlessTests', `âŒ æ— é™æ¨¡å¼æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸¸æˆæ¨¡å¼ç®¡ç†å™¨æµ‹è¯•
        function testGameModeManager() {
            const container = document.getElementById('gameModeTests');
            container.innerHTML = '';

            try {
                // åˆ›å»ºæ¨¡æ‹Ÿæ¸¸æˆå®ä¾‹
                const mockGame = {
                    eventSystem: {
                        on: function(event, callback) {
                            console.log(`EventSystem: ç›‘å¬äº‹ä»¶ ${event}`);
                        },
                        emit: function(event, data) {
                            console.log(`EventSystem: è§¦å‘äº‹ä»¶ ${event}`, data);
                        }
                    }
                };

                const gameModeManager = new GameModeManager(mockGame);
                showTestResult('gameModeTests', 'âœ… æ¸¸æˆæ¨¡å¼ç®¡ç†å™¨å®ä¾‹åŒ–æˆåŠŸ', 'success');

                // æµ‹è¯•æ¨¡å¼åˆ‡æ¢
                const adventureResult = gameModeManager.startMode(LevelConfig.GAME_MODES.ADVENTURE, 1);
                showTestResult('gameModeTests', `âœ… åˆ‡æ¢åˆ°é—¯å…³æ¨¡å¼: ${adventureResult}`, adventureResult ? 'success' : 'error');

                const endlessResult = gameModeManager.startMode(LevelConfig.GAME_MODES.ENDLESS);
                showTestResult('gameModeTests', `âœ… åˆ‡æ¢åˆ°æ— é™æ¨¡å¼: ${endlessResult}`, endlessResult ? 'success' : 'error');

                // æµ‹è¯•çŠ¶æ€
                const status = gameModeManager.getCurrentModeStatus();
                showJSONResult('gameModeTests', status, 'å½“å‰æ¨¡å¼çŠ¶æ€:');

            } catch (error) {
                showTestResult('gameModeTests', `âŒ æ¸¸æˆæ¨¡å¼ç®¡ç†å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // UIç»„ä»¶æµ‹è¯•
        function testUIComponents() {
            const container = document.getElementById('uiTests');
            container.innerHTML = '';

            try {
                // åˆ›å»ºä¸´æ—¶å®¹å™¨
                const tempContainer = document.createElement('div');
                tempContainer.style.display = 'none';
                document.body.appendChild(tempContainer);

                // åˆ›å»ºæ¨¡æ‹Ÿæ¸¸æˆå®ä¾‹
                const mockGame = {
                    eventSystem: {
                        emit: function(event, data) {
                            console.log(`EventSystem: è§¦å‘äº‹ä»¶ ${event}`, data);
                        }
                    }
                };

                const gameModeSelector = new GameModeSelector(tempContainer, mockGame);
                showTestResult('uiTests', 'âœ… æ¸¸æˆæ¨¡å¼é€‰æ‹©å™¨å®ä¾‹åŒ–æˆåŠŸ', 'success');

                // æµ‹è¯•æ˜¾ç¤º/éšè—
                gameModeSelector.show();
                showTestResult('uiTests', 'âœ… æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å™¨æˆåŠŸ', 'success');

                gameModeSelector.hide();
                showTestResult('uiTests', 'âœ… éšè—æ¨¡å¼é€‰æ‹©å™¨æˆåŠŸ', 'success');

                // æ¸…ç†
                document.body.removeChild(tempContainer);

            } catch (error) {
                showTestResult('uiTests', `âŒ UIç»„ä»¶æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é›†æˆæµ‹è¯•
        function runIntegrationTests() {
            const container = document.getElementById('integrationTests');
            container.innerHTML = '';

            try {
                showTestResult('integrationTests', 'ğŸš€ å¼€å§‹é›†æˆæµ‹è¯•...', 'success');

                // åˆ›å»ºå®Œæ•´çš„æ¨¡æ‹Ÿæ¸¸æˆç¯å¢ƒ
                const mockGame = {
                    canvas: { width: 800, height: 600 },
                    eventSystem: {
                        events: {},
                        on: function(event, callback) {
                            if (!this.events[event]) {
                                this.events[event] = [];
                            }
                            this.events[event].push(callback);
                        },
                        emit: function(event, data) {
                            if (this.events[event]) {
                                this.events[event].forEach(callback => {
                                    try {
                                        callback(data);
                                    } catch (error) {
                                        console.error(`äº‹ä»¶å›è°ƒé”™è¯¯ ${event}:`, error);
                                    }
                                });
                            }
                        }
                    },
                    enemySystem: {
                        enemies: [],
                        addEnemy: function(enemy) {
                            this.enemies.push(enemy);
                        }
                    },
                    particleSystem: {
                        createBossSpawnEffect: () => {},
                        createLightningEffect: () => {},
                        createHealingEffect: () => {}
                    }
                };

                // åˆå§‹åŒ–æ‰€æœ‰ç³»ç»Ÿ
                const progressionSystem = new ProgressionSystem(mockGame);
                const gameModeManager = new GameModeManager(mockGame);
                
                mockGame.progressionSystem = progressionSystem;
                mockGame.gameModeManager = gameModeManager;

                showTestResult('integrationTests', 'âœ… æ‰€æœ‰ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');

                // æµ‹è¯•å®Œæ•´çš„æ¸¸æˆæµç¨‹
                
                // 1. å¼€å§‹é—¯å…³æ¨¡å¼
                gameModeManager.startMode(LevelConfig.GAME_MODES.ADVENTURE, 1);
                showTestResult('integrationTests', 'âœ… é—¯å…³æ¨¡å¼å¯åŠ¨æˆåŠŸ', 'success');

                // 2. æ¨¡æ‹Ÿå‡»æ€æ•Œäºº
                mockGame.eventSystem.emit('enemy_killed', {
                    type: 'goblin',
                    experience: 10,
                    isBoss: false
                });
                showTestResult('integrationTests', 'âœ… æ•Œäººå‡»æ€äº‹ä»¶å¤„ç†æˆåŠŸ', 'success');

                // 3. æ¨¡æ‹Ÿå…³å¡å®Œæˆ
                mockGame.eventSystem.emit('level_completed', {
                    levelId: 1,
                    stats: { time: 120, score: 1000 },
                    rewards: { experience: 100, skillPoints: 2 },
                    perfect: true
                });
                showTestResult('integrationTests', 'âœ… å…³å¡å®Œæˆäº‹ä»¶å¤„ç†æˆåŠŸ', 'success');

                // 4. åˆ‡æ¢åˆ°æ— é™æ¨¡å¼
                gameModeManager.startMode(LevelConfig.GAME_MODES.ENDLESS);
                showTestResult('integrationTests', 'âœ… åˆ‡æ¢åˆ°æ— é™æ¨¡å¼æˆåŠŸ', 'success');

                // 5. æ¨¡æ‹Ÿæ— é™æ¨¡å¼ç»“æŸ
                mockGame.eventSystem.emit('endless_mode_ended', {
                    wave: 15,
                    kills: 150,
                    survivalTime: 300,
                    score: 5000,
                    maxCombo: 25,
                    difficulty: 'normal'
                });
                showTestResult('integrationTests', 'âœ… æ— é™æ¨¡å¼ç»“æŸäº‹ä»¶å¤„ç†æˆåŠŸ', 'success');

                // æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
                const finalPlayerData = progressionSystem.getPlayerData();
                showJSONResult('integrationTests', {
                    playerLevel: finalPlayerData.playerLevel,
                    totalExperience: finalPlayerData.totalExperience,
                    completedLevels: finalPlayerData.completedLevels,
                    achievements: finalPlayerData.achievements,
                    endlessRecords: finalPlayerData.endlessRecords
                }, 'æœ€ç»ˆç©å®¶çŠ¶æ€:');

                showTestResult('integrationTests', 'ğŸ‰ é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');

            } catch (error) {
                showTestResult('integrationTests', `âŒ é›†æˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('é›†æˆæµ‹è¯•é”™è¯¯:', error);
            }
        }

        // é‡ç½®è¿›åº¦
        function resetProgress() {
            try {
                localStorage.removeItem('tower_defense_player_data');
                localStorage.removeItem('endless_records');
                showTestResult('progressionTests', 'âœ… è¿›åº¦å·²é‡ç½®', 'success');
            } catch (error) {
                showTestResult('progressionTests', `âŒ é‡ç½®è¿›åº¦å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç³»ç»ŸåŠ è½½æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            testSystemLoading();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>ğŸš¨ å¼ºåˆ¶æ¸…ç†å­˜æ¡£ - Emergency Storage Cleaner</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
            background: #ff1a1a; 
            color: #fff;
            text-align: center;
        }
        .container { background: #cc0000; padding: 30px; border-radius: 10px; border: 3px solid #fff; }
        button { 
            background: #fff; 
            color: #cc0000; 
            border: none; 
            padding: 20px 40px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 18px; 
            font-weight: bold;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        button:hover { background: #f0f0f0; transform: scale(1.05); }
        .result { margin: 20px 0; padding: 15px; background: #990000; border-radius: 5px; }
        .success { background: #006600 !important; }
        h1 { font-size: 2em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .warning { font-size: 1.1em; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ ç´§æ€¥å­˜æ¡£æ¸…ç†å·¥å…·</h1>
        
        <div class="warning">
            âš ï¸ å¦‚æœæ‚¨é‡åˆ°æŒç»­çš„JSONé”™è¯¯ï¼Œè¯·ä½¿ç”¨æ­¤å·¥å…·å¼ºåˆ¶æ¸…ç†æ‰€æœ‰æŸåçš„æ•°æ®
        </div>
        
        <button onclick="emergencyClean()" style="font-size: 20px; padding: 25px 50px;">
            ğŸ§¹ ç«‹å³æ¸…ç†æ‰€æœ‰å­˜æ¡£æ•°æ®
        </button>
        
        <button onclick="checkAndClean()">
            ğŸ” æ£€æŸ¥å¹¶æ¸…ç†
        </button>
        
        <button onclick="goBack()">
            ğŸ® è¿”å›æ¸¸æˆ
        </button>
        
        <div id="result"></div>
        
        <div class="warning" style="margin-top: 30px; font-size: 0.9em;">
            è¿™å°†æ¸…ç†ï¼štowerDefenseProgress, towerDefenseSettings, towerDefenseAchievements, towerDefenseStats
        </div>
    </div>

    <script>
        function log(message, isSuccess = false) {
            const result = document.getElementById('result');
            const div = document.createElement('div');
            div.innerHTML = message;
            div.className = 'result' + (isSuccess ? ' success' : '');
            result.appendChild(div);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function emergencyClean() {
            log('ğŸš¨ å¼€å§‹ç´§æ€¥æ¸…ç†ç¨‹åº...');
            
            const keys = [
                'towerDefenseProgress',
                'towerDefenseSettings', 
                'towerDefenseAchievements',
                'towerDefenseStats',
                'towerDefenseTemp',
                'gameState',
                'playerData'
            ];
            
            let cleaned = 0;
            keys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    cleaned++;
                    log(`âœ… å·²æ¸…ç†: ${key}`, true);
                } else {
                    log(`â„¹ï¸ æœªæ‰¾åˆ°: ${key}`);
                }
            });
            
            // æ¸…ç†æ‰€æœ‰ä»¥ tower å¼€å¤´çš„é”®
            const allKeys = Object.keys(localStorage);
            allKeys.forEach(key => {
                if (key.toLowerCase().includes('tower') || key.toLowerCase().includes('defense')) {
                    localStorage.removeItem(key);
                    cleaned++;
                    log(`âœ… é¢å¤–æ¸…ç†: ${key}`, true);
                }
            });
            
            log(`ğŸ§¹ ç´§æ€¥æ¸…ç†å®Œæˆï¼å…±æ¸…ç† ${cleaned} é¡¹æ•°æ®`, true);
            log('ğŸ“ å»ºè®®ç°åœ¨åˆ·æ–°æ¸¸æˆé¡µé¢', true);
            
            // 3ç§’åè‡ªåŠ¨è·³è½¬
            setTimeout(() => {
                if (confirm('æ¸…ç†å®Œæˆï¼æ˜¯å¦ç«‹å³è¿”å›æ¸¸æˆï¼Ÿ')) {
                    goBack();
                }
            }, 3000);
        }

        function checkAndClean() {
            log('ğŸ” æ£€æŸ¥å­˜æ¡£çŠ¶æ€...');
            
            const progress = localStorage.getItem('towerDefenseProgress');
            if (progress) {
                log('ğŸ“„ æ‰¾åˆ°è¿›åº¦å­˜æ¡£ï¼Œé•¿åº¦: ' + progress.length);
                log('ğŸ“„ å‰100å­—ç¬¦: ' + progress.substring(0, 100));
                
                const corruptedPatterns = ['invalid', 'json}', 'Unexpected token'];
                let isCorrupted = false;
                
                corruptedPatterns.forEach(pattern => {
                    if (progress.includes(pattern)) {
                        log(`âš ï¸ æ£€æµ‹åˆ°æŸåæ¨¡å¼: "${pattern}"`, false);
                        isCorrupted = true;
                    }
                });
                
                if (isCorrupted) {
                    log('ğŸ—‘ï¸ å­˜æ¡£å·²æŸåï¼Œè‡ªåŠ¨æ¸…ç†...', false);
                    emergencyClean();
                } else {
                    try {
                        JSON.parse(progress);
                        log('âœ… å­˜æ¡£æ ¼å¼æ­£å¸¸', true);
                    } catch (error) {
                        log('âŒ JSONè§£æå¤±è´¥: ' + error.message, false);
                        log('ğŸ—‘ï¸ å¼€å§‹è‡ªåŠ¨æ¸…ç†...', false);
                        emergencyClean();
                    }
                }
            } else {
                log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°è¿›åº¦å­˜æ¡£');
            }
        }

        function goBack() {
            window.location.href = 'game.html';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = () => {
            log('ğŸ”§ ç´§æ€¥æ¸…ç†å·¥å…·å·²å°±ç»ª');
            checkAndClean();
        };
    </script>
</body>
</html>
